<!DOCTYPE html>
<html>

<head>
    <title>Google Gemini API</title>
    <meta charset="utf-8" />
</head>

<body>
    <h1>Google Gemini API</h1>
    <form method="post" onsubmit="return handleSubmit(this);">
        <label for="model">Modelo:</label>
        <select id="model" name="model"></select>
        </br>
        <label for="question">Pregunta:</label>
        <input type="textarea" name="question" size="50" />
        </br>
        <label for="file">Archivo:</label>
        <input type="file" name="file" id="file" />
        <button type="button" id="clear" onclick="clearFileField()">Remover Archivo</button>
        </br>
        <button id="submit" type="submit">Enviar</button>
    </form>
    <pre id="response"></pre>
    <script type="text/javascript">

        document.getElementById("submit").disabled = true;
        var geminiLoaded = false;
        clearFileField();

        function loadScriptSync(src, callback) {
            var script = document.createElement('script');
            script.src = src;
            script.type = "text/javascript";
            script.async = true;
            script.defer = true;
            script.onload = callback;
            document.getElementsByTagName('body')[0].appendChild(script);
        }

        async function loadEnvironment() {
            const response = await fetch("./environment.json");
            return await response.json();
        }

        // Load environment variables and logic synchronously
        loadEnvironment().then((environment) => {
            window.environment = environment;
            loadScriptSync("index.js", function () {
                geminiLoaded = true;
                getModelsList();
            });
        });

        function handleSubmit(form) {
            // Prevent default form submission
            event.preventDefault();
            document.getElementById("submit").innerHTML = "Enviando...";
            document.getElementById("submit").disabled = true;
            // Access form data (e.g., using FormData API)
            const formData = new FormData(form);

            console.log(formData);

            const file = formData.get("file");
            console.log(file);

            if (file.size > 0) {
                // Create a new FileReader instance
                const reader = new FileReader();

                // Define what happens when the file is finished loading
                reader.onload = function (e) {
                    // The result is a Data URL (e.g., "data:image/png;base64,iVBORw...")
                    const dataURL = e.target.result;
                    console.log("Data URL:", dataURL);
                    const mimeType = dataURL.match(/^data:(.+);base64,/)[1];
                    console.log("mimeType", mimeType);
                    // Optionally, remove the "data:type;base64," prefix to get only the raw Base64 string
                    const base64String = dataURL.replace(/^data:.+;base64,/, '');

                    // Display the result
                    //base64Output.value = base64String;
                    console.log("Full Data URL:", dataURL);
                    console.log("Raw Base64 String:", base64String);

                    if (geminiLoaded) {
                        gemini25Pro(formData.get("model"), formData.get("question"), base64String, mimeType);
                    }
                };

                // Define what happens if an error occurs
                reader.onerror = function (error) {
                    console.error("Error reading file:", error);
                };

                // Read the file's content as a Data URL, which internally Base64 encodes it
                reader.readAsDataURL(file);
            } else {

                if (geminiLoaded) {
                    gemini25Pro(formData.get("model"), formData.get("question"));
                }

            }

            return false; // Prevent default form submission
        }

        function clearFileField() {
            document.getElementById('file').value = null;
        }

    </script>
</body>

</html>